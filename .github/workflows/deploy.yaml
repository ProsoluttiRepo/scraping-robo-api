name: Deploy Scraping Service

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Baixa o c√≥digo
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Instala SSH + rsync
      - name: Install SSH + rsync
        run: sudo apt-get update && sudo apt-get install -y sshpass openssh-client rsync

      # 3Ô∏è‚É£ Copia c√≥digo para o servidor via rsync (sem .env)
      - name: Copy project to remote server via rsync
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" rsync -avz --delete --exclude=".env" \
            -e "ssh -o StrictHostKeyChecking=no -p 22100" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_APP_PATH }}/

      - name: Clear Redis keys
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 22100 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "üî• Limpando chaves do Redis..."
            COUNT=$(redis-cli -h redis -p 6379 KEYS "pje:auth:cookies:*" | xargs -r redis-cli -h redis -p 6379 DEL)
            echo "‚úÖ $COUNT chaves removidas"
            echo "üîç Restantes:"
            redis-cli -h redis -p 6379 KEYS "pje:auth:cookies:*"
          EOF

      # 5Ô∏è‚É£ Builda e sobe os containers no servidor
      - name: Build and run with Docker Compose
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 22100 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.SSH_APP_PATH }}
            echo "Recriando container scraping-robo..."
            docker rm -f scraping-robo || true
            docker compose up -d --build scraping-robo
          EOF
